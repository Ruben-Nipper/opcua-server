<!-- opcua-server.html -->
<script type="text/javascript">
(function () {

    function defaultVars() { return []; }

    RED.nodes.registerType('opcua-server-nipper', {
        category: 'nipper',
        color: '#fcc91e',
        icon: 'font-awesome/fa-server',
        defaults: {
            name: { value: "" },
            port: { value: 4840, required: true, validate: RED.validators.number() },
            resourcePath: { value: "/UA/MyServer", required: true },
            hostname: { value: "0.0.0.0", required: true },
            allowAnonymous: { value: true },
            variables: { value: defaultVars() }
        },
        inputs: 1,
        outputs: 1,
        label: function () { return this.name || "opcua-server-nipper"; },

        oneditprepare: function () {
            $("#node-input-allowAnonymous").prop("checked", !!this.allowAnonymous);

            let parsed = [];
            try {
                if (Array.isArray(this.variables)) {
                    parsed = this.variables;
                } else if (typeof this.variables === "string"&& this.variables.trim().length) {
                    parsed = JSON.parse(this.variables);
                }
            } catch (e) {
                parsed = [];
            }

            const list = $("#node-input-variables-container")
                .css('min-height', '240px')
                .editableList({
                    addItem: function (container, i, item) {
                        item = item || {};

                        const row = $('<div/>', { class: 'opcua-var-row' }).appendTo(container);

                        $('<label/>', { class: 'opcua-lbl', text: 'IXON-VAR' }).appendTo(row);
                        const name = $('<input/>', {
                            type: 'text', class: 'opcua-inp', style: 'width:160px'
                        }).val(item.name || "").appendTo(row);

                        $('<label/>', { class: 'opcua-lbl', text: 'GLOBAL-VAR' }).appendTo(row);
                        const topic = $('<input/>', {
                            type: 'text', class: 'opcua-inp', style: 'width:200px'
                        }).val(item.topic || "").appendTo(row);

                        $('<label/>', { class: 'opcua-lbl', text: 'datatype' }).appendTo(row);
                        const dtype = $('<select/>', {
                            class: 'opcua-inp', style: 'width:140px'
                        }).appendTo(row);
                        [
                            "Boolean","SByte","Byte","Int16","UInt16","Int32","UInt32",
                            "Float","Double","String","DateTime"
                        ].forEach(function (t) {
                            $('<option/>', { value: t }).text(t).appendTo(dtype);
                        });
                        dtype.val(item.dataType || "Int32");

                        $('<label/>', { class: 'opcua-lbl', text: 'client write' }).appendTo(row);
                        const wsel = $('<select/>', {
                            class: 'opcua-inp', style: 'width:140px'
                        }).appendTo(row);
                        $('<option/>', { value: 'allow' }).text('toestaan').appendTo(wsel);
                        $('<option/>', { value: 'deny' }).text('weigeren').appendTo(wsel);
                        const writable = (item.writable === undefined) ? true : !!item.writable;
                        wsel.val(writable ? 'allow' : 'deny');

                        // koppel getter op het item
                        $(container).data('getItem', function () {
                            return {
                                name: name.val(),
                                topic: topic.val(),
                                dataType: dtype.val(),
                                writable: wsel.val() === 'allow'
                            };
                        });
                    },
                    removable: true,
                    sortable: true
                });

            if (Array.isArray(parsed)) {
                parsed.forEach(v => list.editableList('addItem', v));
            }
        },

        oneditsave: function () {
            const items = $("#node-input-variables-container").editableList('items');
            const out = [];
            items.each(function (i, el) {
                const getter = $(el).data('getItem');
                if (typeof getter === 'function') out.push(getter());
            });
            $("#node-input-variables").val(JSON.stringify(out));
            this.variables = out;
            this.allowAnonymous = $("#node-input-allowAnonymous").is(":checked");
        }
    });

})();
</script>

<style>
    .nr-field { margin-bottom: 8px; }
    .opcua-var-row { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    .opcua-lbl { width: 90px; display: inline-block; }
    .opcua-inp { vertical-align: middle; }
</style>

<script type="text/x-red" data-template-name="opcua-server-nipper">
    <div class="nr-field">
        <label for="node-input-name">naam</label>
        <input type="text" id="node-input-name">
    </div>

    <div class="nr-field">
        <label for="node-input-port">port</label>
        <input type="number" id="node-input-port">
    </div>

    <div class="nr-field">
        <label for="node-input-resourcePath">resourcePath</label>
        <input type="text" id="node-input-resourcePath" placeholder="/UA/MyServer">
    </div>

    <div class="nr-field">
        <label for="node-input-hostname">hostname</label>
        <input type="text" id="node-input-hostname" placeholder="0.0.0.0">
    </div>

    <div class="nr-field">
        <label for="node-input-allowAnonymous">allowAnonymous</label>
        <input type="checkbox" id="node-input-allowAnonymous">
    </div>

    <div class="nr-field">
        <input type="hidden" id="node-input-variables">
        <label>variabelen</label>
        <div id="node-input-variables-container"></div>
        <div>vul per rij naam, topic, datatype, en client write in</div>
    </div>
</script>

<script type="text/x-red" data-help-name="opcua-server-nipper">
    <p>Start een OPC UA server en maakt variabelen aan, kies per variabele of een client mag schrijven of niet, schrijf vanuit je flow met msg.topic en msg.payload, een client write wordt geweigerd als je “weigeren” kiest</p>
</script>
